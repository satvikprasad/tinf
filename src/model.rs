use std::alloc::Layout;

use crate::{
    ops::{self, Execute},
    tensor::{Tensor, TensorShape, TensorType},
};

#[derive(Debug)]
pub struct Node {
    pub op: ops::Op,
    pub inputs: Vec<usize>,
    pub outputs: Vec<usize>,
}

#[derive(Debug)]
pub struct Model {
    /** Topologically sorted series of nodes. */
    pub nodes: Vec<Node>,
    pub tensor_buffer_mapping: Vec<usize>,

    pub tensor_shapes: Vec<TensorShape>,
    pub tensor_types: Vec<TensorType>,

    pub arena: *mut u8,
    pub arena_layout: Layout,

    pub buffer_offsets: Vec<usize>,
    pub buffer_sizes: Vec<usize>, // TODO(satvik): Perhaps store raw pointers instead if we're in a hot
                                  // loop.
}

impl Node {
    pub fn execute(&self) {}
}

impl Model {
    pub fn execute(&mut self) {
        let mut input_tensor = unsafe {
            Tensor::from_arena(
                self.arena,
                self.buffer_offsets[self.tensor_buffer_mapping[self.nodes[0].inputs[0]]],
                self.tensor_shapes[self.nodes[0].inputs[0]],
                TensorType::F32,
            )
        };

        let input_tensor_data: &mut [f32] = input_tensor.data_mut_unchecked();

        input_tensor_data.copy_from_slice(&[
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.2,
            0.6235294117647059,
            0.9921568627450981,
            0.6235294117647059,
            0.19607843137254902,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.18823529411764706,
            0.9333333333333333,
            0.9882352941176471,
            0.9882352941176471,
            0.9882352941176471,
            0.9294117647058824,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.21176470588235294,
            0.8901960784313725,
            0.9921568627450981,
            0.9882352941176471,
            0.9372549019607843,
            0.9137254901960784,
            0.9882352941176471,
            0.2235294117647059,
            0.023529411764705882,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0392156862745098,
            0.23529411764705882,
            0.8784313725490196,
            0.9882352941176471,
            0.9921568627450981,
            0.9882352941176471,
            0.792156862745098,
            0.32941176470588235,
            0.9882352941176471,
            0.9921568627450981,
            0.47843137254901963,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.6392156862745098,
            0.9882352941176471,
            0.9882352941176471,
            0.9882352941176471,
            0.9921568627450981,
            0.9882352941176471,
            0.9882352941176471,
            0.3764705882352941,
            0.7411764705882353,
            0.9921568627450981,
            0.6549019607843137,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.2,
            0.9333333333333333,
            0.9921568627450981,
            0.9921568627450981,
            0.7450980392156863,
            0.4470588235294118,
            0.9921568627450981,
            0.8941176470588236,
            0.1843137254901961,
            0.30980392156862746,
            1.0,
            0.6588235294117647,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.18823529411764706,
            0.9333333333333333,
            0.9882352941176471,
            0.9882352941176471,
            0.7019607843137254,
            0.047058823529411764,
            0.29411764705882354,
            0.4745098039215686,
            0.08235294117647059,
            0.0,
            0.0,
            0.9921568627450981,
            0.9529411764705882,
            0.19607843137254902,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.14901960784313725,
            0.6470588235294118,
            0.9921568627450981,
            0.9137254901960784,
            0.8156862745098039,
            0.32941176470588235,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.9921568627450981,
            0.9882352941176471,
            0.6470588235294118,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.027450980392156862,
            0.6980392156862745,
            0.9882352941176471,
            0.9411764705882353,
            0.2784313725490196,
            0.07450980392156863,
            0.10980392156862745,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.9921568627450981,
            0.9882352941176471,
            0.7647058823529411,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.2235294117647059,
            0.9882352941176471,
            0.9882352941176471,
            0.24705882352941178,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.9921568627450981,
            0.9882352941176471,
            0.7647058823529411,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.7764705882352941,
            0.9921568627450981,
            0.7450980392156863,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            1.0,
            0.9921568627450981,
            0.7686274509803922,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.2980392156862745,
            0.9647058823529412,
            0.9882352941176471,
            0.4392156862745098,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.9921568627450981,
            0.9882352941176471,
            0.5803921568627451,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3333333333333333,
            0.9882352941176471,
            0.9019607843137255,
            0.09803921568627451,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.027450980392156862,
            0.5294117647058824,
            0.9921568627450981,
            0.7294117647058823,
            0.047058823529411764,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3333333333333333,
            0.9882352941176471,
            0.8745098039215686,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.027450980392156862,
            0.5137254901960784,
            0.9882352941176471,
            0.8823529411764706,
            0.2784313725490196,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3333333333333333,
            0.9882352941176471,
            0.5686274509803921,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.18823529411764706,
            0.6470588235294118,
            0.9882352941176471,
            0.6784313725490196,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.33725490196078434,
            0.9921568627450981,
            0.8823529411764706,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.4470588235294118,
            0.9333333333333333,
            0.9921568627450981,
            0.6352941176470588,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3333333333333333,
            0.9882352941176471,
            0.9764705882352941,
            0.5725490196078431,
            0.18823529411764706,
            0.11372549019607843,
            0.3333333333333333,
            0.6980392156862745,
            0.8823529411764706,
            0.9921568627450981,
            0.8745098039215686,
            0.6549019607843137,
            0.2196078431372549,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3333333333333333,
            0.9882352941176471,
            0.9882352941176471,
            0.9882352941176471,
            0.8980392156862745,
            0.8431372549019608,
            0.9882352941176471,
            0.9882352941176471,
            0.9882352941176471,
            0.7686274509803922,
            0.5098039215686274,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.10980392156862745,
            0.7803921568627451,
            0.9882352941176471,
            0.9882352941176471,
            0.9921568627450981,
            0.9882352941176471,
            0.9882352941176471,
            0.9137254901960784,
            0.5686274509803921,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.09803921568627451,
            0.5019607843137255,
            0.9882352941176471,
            0.9921568627450981,
            0.9882352941176471,
            0.5529411764705883,
            0.1450980392156863,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ]);

        for node in self.nodes.iter() {
            node.op.execute(&node.inputs, &node.outputs, self);
        }

        let out = self.nodes[self.nodes.len() - 1].outputs[0];
        let out_buf = self.tensor_buffer_mapping[out];

        let out_tensor = unsafe {
            Tensor::from_arena(
                self.arena,
                self.buffer_offsets[out_buf],
                self.tensor_shapes[out],
                self.tensor_types[out],
            )
        };
    }
}
